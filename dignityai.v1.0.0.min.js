function DignityObject(){this.appContext=null;this.name="";this.tag="";this.layer="";this.isEnable=true};function DignityAction(){DignityObject.call(this);this.createObj=null;this.createObjPos=null;this.destroyObj=new DignityAIBase;this.destroyLevel=0;this.upgradeObj=null;this.upgradeObjPropName="";this.upgradeObjIncVal=0;this.upgradeObjNewVal=0;this.moveObj=new DignityAIBase;this.moveFollowObj=null;this.senseObj=new DignityAIBase;this.senseRadius=0;this.senseTriggerTime=0;this.customActionObj=null;this.customActionName="";this.ammo=0;this.fireSpeed=0;this.maxTurnAngle=0};DignityAction.prototype=Object.create(DignityObject.prototype);DignityAction.prototype.constructor=DignityAction;DignityAction.prototype.create=function(){var a=this.createObj.clone();this.createObj.setPosition(this.createObjPos)};DignityAction.prototype.destroy=function(){this.destroyObj.life-=this.destroyLevel};DignityAction.prototype.upgrade=function(){if(this.upgradeObj.hasOwnProperty(this.upgradeObjPropName)){if(this.upgradeObjIncVal>0){this.upgradeObj[this.upgradeObjPropName]+=this.upgradeObjIncVal}else if(this.upgradeObjNewVal>0){this.upgradeObj[this.upgradeObjPropName]=this.upgradeObjNewVal}}};DignityAction.prototype.move=function(){if(this.moveObj!=null){this.moveObj.moveStart=true;this.moveObj.moveEnd=false}};DignityAction.prototype.sense=function(){if(this.senseObj!=null){this.senseObj.senseRadius=this.senseRadius;this.senseObj.senseStart=true;this.senseObj.senseEnd=false}};DignityAction.prototype.custom=function(){this.customActionObj[this.customActionName]()};function DignityMission(){DignityObject.call(this);this.desc="";this.actionStart=new DignityAction;this.actionStartName="";this.actionEnd=new DignityAction;this.actionEndName="";this.actionTime=new DignityAction;this.actionTimeName="";this.finishTime=0;this.time=0;this.continuous=false;this.async=false;this.end=false};DignityMission.prototype=Object.create(DignityObject.prototype);DignityMission.prototype.constructor=DignityMission;DignityMission.prototype.executeAction=function(a,b){a[b]()};DignityMission.prototype.executeEndAction=function(){if(this.actionEndName!=="")this.actionEnd[this.actionEndName]()};DignityMission.prototype.execute=function(){if(this.finishTime>0){this.executeAction(this.actionStart,this.actionStartName);window.setTimeout(this.executeAction,this.finishTime,this.actionEnd,this.actionEndName)}else if(this.time<=0){if(this.end){this.executeAction(this.actionEnd,this.actionEndName)}else{this.executeAction(this.actionStart,this.actionStartName)}}if(this.time>0){if(this.continuous){window.setInterval(this.executeAction,this.time,this.actionTime,this.actionTimeName)}else{window.setTimeout(this.executeAction,this.time,this.actionTime,this.actionTimeName)}}};function DignityPath(){DignityObject.call(this);this.from=[];this.subPaths=[];this.to=[];this.isPong=false;this.randomable=false;this.randomRange=0;this.map=[[]];this.movementPath=[];this.movementPathCurrent=0};DignityPath.prototype=Object.create(DignityObject.prototype);DignityPath.prototype.constructor=DignityPath;DignityPath.prototype.findPath=function(){var m=this.map;var n=m[0].length;var o=m.length;var p=n*o;var q=this.from;var r=this.to;if(this.randomable){var s=Math.floor((Math.random()*(n-2-this.randomRange))+1);var t=Math.floor((Math.random()*(o-2-this.randomRange))+1);var u=this.map[s][t];while(u===1){s=Math.floor((Math.random()*(n-2))+1);t=Math.floor((Math.random()*(o-2))+1);u=this.map[s][t]}r=[s,t]}var v=Math.abs;var w=Math.max;var z=Math.pow;var A=Math.sqrt;var B=0;var C=DiagonalDistance;var D=DiagonalNeighbours;function ManhattanDistance(a,b){return v(a.x-b.x)+v(a.y-b.y)}function DiagonalDistance(a,b){return w(v(a.x-b.x),v(a.y-b.y))}function EuclideanDistance(a,b){return A(z(a.x-b.x,2)+z(a.y-b.y,2))}function Neighbours(x,y){var N=y-1,S=y+1,E=x+1,W=x-1,myN=N>-1&&canWalkHere(x,N),myS=S<o&&canWalkHere(x,S),myE=E<n&&canWalkHere(E,y),myW=W>-1&&canWalkHere(W,y),result=[];if(myN)result.push({x:x,y:N});if(myE)result.push({x:E,y:y});if(myS)result.push({x:x,y:S});if(myW)result.push({x:W,y:y});D(myN,myS,myE,myW,N,S,E,W,result);return result}function DiagonalNeighbours(a,b,c,d,N,S,E,W,e){if(a){if(c&&canWalkHere(E,N))e.push({x:E,y:N});if(d&&canWalkHere(W,N))e.push({x:W,y:N})}if(b){if(c&&canWalkHere(E,S))e.push({x:E,y:S});if(d&&canWalkHere(W,S))e.push({x:W,y:S})}}function DiagonalNeighboursFree(a,b,c,d,N,S,E,W,e){a=N>-1;b=S<o;c=E<n;d=W>-1;if(c){if(a&&canWalkHere(E,N))e.push({x:E,y:N});if(b&&canWalkHere(E,S))e.push({x:E,y:S})}if(d){if(a&&canWalkHere(W,N))e.push({x:W,y:N});if(b&&canWalkHere(W,S))e.push({x:W,y:S})}}function canWalkHere(x,y){return((m[x]!=null)&&(m[x][y]!=null)&&(m[x][y]<=B))};function Node(a,b){var c={Parent:a,value:b.x+(b.y*n),x:b.x,y:b.y,f:0,g:0};return c}function calculatePath(){var a=Node(null,{x:q[0],y:q[1]});var b=Node(null,{x:r[0],y:r[1]});var c=new Array(p);var d=[a];var e=[];var f=[];var g;var h;var k;var l,w,min,i,j;while(l=d.length){w=p;min=-1;for(i=0;i<l;i++){if(d[i].f<w){w=d[i].f;min=i}}h=d.splice(min,1)[0];if(h.value===b.value){k=e[e.push(h)-1];do{f.push([k.x,k.y])}while(k=k.Parent);c=e=d=[];f.reverse()}else{g=Neighbours(h.x,h.y);for(i=0,j=g.length;i<j;i++){k=Node(h,g[i]);if(!c[k.value]){k.g=h.g+C(g[i],h);k.f=k.g+C(g[i],b);d.push(k);c[k.value]=true}}e.push(h)}}return f}this.movementPath=calculatePath();this.movementPathCurrent=0};function DignityAIBase(){DignityObject.call(this);this.parentObject=null;this.bullets=null;this.life=100;this.value=0;this.level=0;this.speed=1;this.missionList=[];this.missionIndex=0;this.friendList=[];this.enemyList=[];this.obstacleList=[];this.collectableList=[];this.ignoreList=[];this.pathList=[];this.pathIndex=0;this.moveStart=false;this.moveEnd=false;this.senseRadius=1;this.senseStart=false;this.senseEnd=false;this.collectedObjects=[]};DignityAIBase.prototype=Object.create(DignityObject.prototype);DignityAIBase.prototype.constructor=DignityAIBase;DignityAIBase.prototype.start=function(){for(var i=0;i<this.missionList.length;i++){if(this.missionList[i].async){this.missionList[i].execute()}}if(!this.missionList[this.missionIndex].async)this.missionList[this.missionIndex].execute()};DignityAIBase.prototype.executeMission=function(){this.missionList[this.missionIndex].execute()};DignityAIBase.prototype.nextMission=function(){if(this.missionList.length>0&&this.missionIndex<this.missionList.length){this.missionIndex++}else{this.missionIndex=0}};DignityAIBase.prototype.prevMission=function(){if(this.missionList.length>0&&this.missionIndex>0){this.missionIndex--}else{this.missionIndex=0}};DignityAIBase.prototype.nextPath=function(){if(this.pathList.length>0&&this.pathIndex<this.pathList.length){this.pathIndex++}else{this.pathIndex=0}};DignityAIBase.prototype.prevPath=function(){if(this.pathList.length>0&&this.pathIndex>0){this.pathIndex--}else{this.pathIndex=0}};DignityAIBase.prototype.move=function(a){if(this.moveStart&&!this.moveEnd){if(this.pathList.length>0&&this.pathIndex<this.pathList.length){var b=this.pathList[this.pathIndex];var c=b.movementPath.length;if(c>0&&b.movementPathCurrent<c){var x=0.5+(b.movementPath[b.movementPathCurrent][1]*1);var z=47.5-(b.movementPath[b.movementPathCurrent][0]*1);a.movePoint=new pc.Vec3(x,0,z);var d=a.entity.getPosition();var e=new pc.Vec3();e.lerp(d,a.movePoint,0.025);a.entity.setPosition(e);if(d.x.toFixed(1)>(x.toFixed(1)-1)&&d.z.toFixed(1)>(z.toFixed(1)-1)){b.movementPathCurrent++;console.log('current movePath: '+b.movementPathCurrent)}if(b.movementPathCurrent===b.movementPath.length){this.nextPath();this.moveEnd=true;this.moveStart=false;var f=this.missionList[this.missionIndex];if(f.actionEnd!=null){f.end=true;f.executeEndAction();this.nextMission()}}}}}};DignityAIBase.prototype.sense=function(a,b){if(this.senseStart&&!this.senseEnd){var c=a.entity.getPosition();c.x=Math.floor(c.x);c.z=Math.floor(c.z);c.y=0.0;var d=c.clone(),ray2=c.clone(),ray3=c.clone(),ray4=c.clone(),ray5=c.clone();var e="front";var f=this.senseRadius*6;var g=this.senseRadius*2;var h=this.senseRadius*1;switch(e){case"left":d.x-=f;ray2.x-=f;ray3.x-=f;ray4.x-=f;ray5.x-=f;ray2.z+=g;ray3.z-=g;ray4.z+=h;ray5.z-=h;break;case"right":d.x+=f;ray2.x+=f;ray3.x+=f;ray4.x+=f;ray5.x+=f;ray2.z+=g;ray3.z-=g;ray4.z+=h;ray5.z-=h;break;case"front":d.z+=f;ray2.z+=f;ray3.z+=f;ray4.z+=f;ray5.z+=f;ray2.x+=g;ray3.x-=g;ray4.x+=h;ray5.x-=h;break;case"back":d.z-=f;ray2.z-=f;ray3.z-=f;ray4.z-=f;ray5.z-=f;ray2.x+=g;ray3.x-=g;ray4.x+=h;ray5.x-=h;break}this.cast(b,a,d.x,d.y,d.z);this.cast(b,a,ray2.x,ray2.y,ray2.z);this.cast(b,a,ray3.x,ray3.y,ray3.z);this.cast(b,a,ray4.x,ray4.y,ray4.z);this.cast(b,a,ray5.x,ray5.y,ray5.z)}};DignityAIBase.prototype.cast=function(a,b,x,y,z){if(this.senseStart&&!this.senseEnd){var c=new pc.Vec3();var d=new pc.Vec3(x,y,z);c.copy(b.entity.getPosition());c.y=0.0;a.systems.rigidbody.raycastFirst(c,d,this.findHit.bind(this))}};DignityAIBase.prototype.findHit=function(a){if(this.senseStart&&!this.senseEnd){var b=a.entity.getName().split("_")[0];var c=true;if(this.ignoreList.indexOf(b)<0){if(this.friendList.indexOf(b)>=0){console.log('detected friend: '+b);this.detectedFriend(a.entity);c=false}if(this.enemyList.indexOf(b)>=0){console.log('detected enemy: '+b);this.detectedEnemy(a.entity);c=false}if(this.collectableList.indexOf(b)>=0){console.log('detected collectable: '+b);this.detectedCollectable(a.entity);c=false}if(this.obstacleList.indexOf(b)>=0){console.log('detected obstacle: '+b);this.detectedObstacle(a.entity);c=false}if(c){console.log('detected object: '+b);this.detectedOther(a.entity)}}}};DignityAIBase.prototype.stopSense=function(){this.senseEnd=true;this.senseStart=false;var a=this.missionList[this.missionIndex];if(a.actionEnd!=null){a.end=true;a.executeEndAction();this.nextMission()}};DignityAIBase.prototype.detectedFriend=function(a){console.log('detectedFriend action base')};DignityAIBase.prototype.detectedEnemy=function(a){console.log('detectedEnemy action base')};DignityAIBase.prototype.detectedCollectable=function(a){console.log('detectedCollectable action base')};DignityAIBase.prototype.detectedObstacle=function(a){console.log('detectedObstacle action base')};DignityAIBase.prototype.detectedOther=function(a){console.log('detectedOther action base')};DignityAIBase.prototype.shoot=function(a,b){console.log('shoot action base');a.new({id:new Date().getTime(),from:this.parentObject,tx:b.getPosition().x,ty:b.getPosition().z,sp:1})};function DignityVehicle(){DignityAIBase.call(this);this.engineLife=100;this.driveSpeed=1;this.onAir=false;this.onSea=false;this.onRail=false;this.onRoad=false;this.updateSpeed()};DignityVehicle.prototype=Object.create(DignityAIBase.prototype);DignityVehicle.prototype.constructor=DignityVehicle;DignityVehicle.prototype.updateSpeed=function(){this.speed=this.driveSpeed*(this.engineLife/100)};DignityVehicle.prototype.crashVehicle=function(a){if(a>0){this.engineLife-=a;this.updateSpeed()}if(this.engineLife<=0){this.stopEngine()}};DignityVehicle.prototype.stopEngine=function(){this.speed=0};DignityVehicle.prototype.repairEngine=function(a){if(a>0){this.engineLife+=a;this.updateSpeed()}};DignityVehicle.prototype.detectedFriend=function(a){console.log('vehicle detectedFriend action')};DignityVehicle.prototype.detectedEnemy=function(a){console.log('vehicle detectedEnemy action');this.bullets=this.appContext.root.getChildren()[0].script.bullets;this.shoot(this.bullets,a)};function DignityStructure(){DignityAIBase.call(this);this.destroyable=true;this.storeCapacity=0;this.storeObjects=[];this.outputObject=null;this.outputObjects=[];this.outputTime=0};DignityStructure.prototype=Object.create(DignityAIBase.prototype);DignityStructure.prototype.constructor=DignityStructure;DignityStructure.prototype.destroy=function(){if(this.destroyable){this.storeCapacity=0;this.storeObjects=[];this.outputObjects=[];this.outputTime=0}};DignityStructure.prototype.store=function(a){if(this.storeCapacity>0&&this.storeCapacity<this.storeObjects.length){this.storeObjects.push(a)}};DignityStructure.prototype.generate=function(a){if(this.outputTime>0){window.setTimeout(this.pushOutput,this.outputTime,a)}else{this.pushOutput(a)}};DignityStructure.prototype.pushOutput=function(a){this.outputObjects.push(this.outputObject);if(a){this.store(this.outputObject)}};function DignityHuman(){DignityAIBase.call(this);this.senseEnemySpeed=0;this.isFindCover=false;this.fearEnemyLevel=0};DignityHuman.prototype=Object.create(DignityAIBase.prototype);DignityHuman.prototype.constructor=DignityHuman;DignityHuman.prototype.detectedFriend=function(a){console.log('human detectedFriend action')};DignityHuman.prototype.detectedEnemy=function(a){console.log('human detectedEnemy action');this.bullets=this.appContext.root.getChildren()[0].script.bullets;this.shoot(this.bullets,a)};DignityHuman.prototype.detectedOther=function(a){console.log('detectedOther action base');var b=result.entity.getName();if(this.isFindCover){if(b.indexOf('cover')>=0){this.coverObject(a)}}};DignityHuman.prototype.coverObject=function(a){console.log("human cover object");this.speed=0};function DignityAnimal(){DignityAIBase.call(this);this.type="";this.isHuntHuman=false;this.isHuntSameType=false;this.isLiveCrowd=false};DignityAnimal.prototype=Object.create(DignityAIBase.prototype);DignityAnimal.prototype.constructor=DignityAnimal;DignityAnimal.prototype.detectedFriend=function(a){console.log('human detectedFriend action');if(this.isHuntHuman){if(a.getName().indexOf('human')>=0){this.huntHuman(a)}}if(this.isHuntSameType){if(a.getName().indexOf('animal')>=0){this.huntAnimal(a)}}};DignityAnimal.prototype.detectedEnemy=function(a){console.log('human detectedEnemy action');this.bullets=this.appContext.root.getChildren()[0].script.bullets;this.shoot(this.bullets,a)};DignityAnimal.prototype.huntHuman=function(a){console.log('human hunting');this.bullets=this.appContext.root.getChildren()[0].script.bullets;this.shoot(this.bullets,a)};DignityAnimal.prototype.huntAnimal=function(a){console.log('animal hunting');this.bullets=this.appContext.root.getChildren()[0].script.bullets;this.shoot(this.bullets,a)};